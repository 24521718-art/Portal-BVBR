<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ Sơ Khám Chữa Bệnh Online</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải Chart.js (Thư viện biểu đồ) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Định nghĩa bảng màu tùy chỉnh dựa trên yêu cầu */
        .color-primary { background-color: #005BB1; } /* Blue 1 */
        .color-primary-text { color: #005BB1; }
        .color-dark { background-color: #002C65; } /* Dark Blue */
        .color-dark-text { color: #002C65; }
        .color-light-bg { background-color: #F9F9F9; } /* Light Gray */
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFFFFF;
        }

        /* Kiểu cho nút menu bên trái - ĐÃ THU NHỎ PADDING DỌC */
        .sidebar-nav-item {
            padding: 0.5rem 1rem; 
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            border-radius: 0.5rem;
        }
        .sidebar-nav-item:hover {
            background-color: rgba(0, 91, 177, 0.1); /* Hover nhẹ nhàng */
        }
        .sidebar-nav-item.active {
            background-color: #005BB1;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 91, 177, 0.3), 0 2px 4px -2px rgba(0, 91, 177, 0.3);
        }

        /* Kiểu cho phần lịch sử KCB (Accordion) */
        .kcb-accordion-header {
            cursor: pointer;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kcb-accordion-header:hover {
            background-color: #e6f0f7;
        }

        .kcb-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
            padding: 0 1.5rem;
        }
        .kcb-accordion-content.open {
            max-height: 1000px; /* Giá trị lớn để chứa nội dung */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .kcb-detail-item {
            margin-bottom: 0.75rem;
        }

        /* Đảm bảo biểu đồ có chiều cao cố định để hiển thị tốt */
        .chart-container {
            position: relative;
            height: 300px; 
            width: 100%;
        }

    </style>
</head>
<body class="color-light-bg min-h-screen">

    <!-- Cấu hình container chính: flex-col trên mobile, md:flex-row trên desktop, h-screen (chiều cao 100% viewport) -->
    <div class="flex flex-col md:flex-row h-screen overflow-hidden">
        
        <!-- Sidebar (Thanh điều hướng bên trái) -->
        <!-- ĐÃ CHỈNH SỬA: responsive rounded corners -->
        <aside class="w-full md:w-64 color-dark p-6 text-white shadow-lg flex-shrink-0 
                      rounded-xl md:rounded-r-xl md:rounded-l-none">
            <!-- Thông tin Hồ sơ -->
            <div class="flex flex-col items-center mb-8 pt-4"> 
                <div class="w-20 h-20 bg-gray-300 rounded-lg flex items-center justify-center mb-3">
                    <!-- Placeholder ảnh đại diện -->
                    <svg class="w-10 h-10 text-gray-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                </div>
                <h2 class="text-xl font-semibold text-center">Nguyễn Văn A</h2>
                <p class="text-sm text-gray-300">MSBN: <span class="font-mono">12345678</span></p>
            </div>

            <!-- Menu Điều hướng -->
            <nav class="space-y-1"> 
                <div class="sidebar-nav-item color-dark-text bg-white" data-tab="thong-tin-ca-nhan">
                    Thông tin cá nhân
                </div>
                <div class="sidebar-nav-item active" data-tab="lich-su-kcb">
                    Lịch sử KCB
                </div>
                <!-- MỤC MỚI: Biến động chỉ số -->
                <div class="sidebar-nav-item color-dark-text bg-white" data-tab="bien-dong-chi-so">
                    Biến động chỉ số
                </div>
                <div class="sidebar-nav-item color-dark-text bg-white" data-tab="hd-cham-soc">
                    HD chăm sóc sức khỏe
                </div>
                <!-- MỤC MỚI: Hỗ trợ chẩn đoán -->
                <div class="sidebar-nav-item color-dark-text bg-white" data-tab="ho-tro-chan-doan">
                    Hỗ trợ chẩn đoán
                </div>
            </nav>

            <!-- Nút Đăng xuất - ĐÃ GIẢM KHOẢNG CÁCH TRÊN -->
            <div class="mt-6 pt-4 border-t border-gray-700"> 
                <!-- Đã chỉnh màu chữ mặc định sang đỏ nhạt, hover nền đỏ mạnh và chữ trắng -->
                <button class="w-full text-left sidebar-nav-item flex items-center justify-center bg-transparent text-red-300 font-semibold hover:bg-red-700 hover:text-white transition duration-200">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    Đăng xuất
                </button>
            </div>
        </aside>

        <!-- Main Content (Nội dung chính) -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <div id="content-area" class="bg-white p-6 md:p-8 rounded-xl shadow-md min-h-full">
                <!-- Nội dung sẽ được tải vào đây dựa trên tab được chọn -->
                
                <!-- Tab: Lịch sử KCB (Mặc định) -->
                <div id="lich-su-kcb-content" class="tab-content active">
                    <h1 class="text-2xl md:text-3xl font-bold color-dark-text mb-6 pb-2 border-b-2 border-color-primary">
                        Lịch sử khám chữa bệnh
                    </h1>
                    
                    <div class="space-y-4">
                        <!-- Khám lần 1 (Ngày khám: Accordion Item) -->
                        <div class="kcb-accordion-item rounded-lg border border-gray-200">
                            <div class="kcb-accordion-header color-primary-text bg-color-light-bg" onclick="toggleAccordion(this)">
                                <span>Ngày khám: 15/11/2025</span>
                                <svg class="w-5 h-5 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="kcb-accordion-content open">
                                <div class="space-y-3">
                                    <div class="kcb-detail-item">
                                        <p class="font-semibold text-gray-700">Triệu chứng:</p>
                                        <p class="text-sm text-gray-600">Sốt cao 39 độ, đau họng, ho khan liên tục.</p>
                                    </div>
                                    <div class="kcb-detail-item">
                                        <p class="font-semibold text-gray-700">Kết quả xét nghiệm / chẩn đoán hình ảnh:</p>
                                        <p class="text-sm text-gray-600">Xét nghiệm máu (CBC): Bạch cầu tăng nhẹ. Phim X-quang phổi: Trong giới hạn bình thường.</p>
                                    </div>
                                    <div class="kcb-detail-item">
                                        <p class="font-semibold text-gray-700">Chẩn đoán của bác sĩ:</p>
                                        <p class="text-sm text-gray-600 color-primary-text font-medium">Viêm họng cấp do virus.</p>
                                    </div>
                                    <div class="kcb-detail-item">
                                        <p class="font-semibold text-gray-700">Phác đồ điều trị:</p>
                                        <p class="text-sm text-gray-600">Nghỉ ngơi, bù nước, thuốc hạ sốt và giảm đau.</p>
                                    </div>
                                    <div class="kcb-detail-item">
                                        <p class="font-semibold text-gray-700">Toa thuốc đã kê:</p>
                                        <p class="text-sm text-gray-600">Paracetamol 500mg (2 viên/ngày), Siro ho thảo dược.</p>
                                    </div>
                                    <div class="kcb-detail-item">
                                        <p class="font-semibold text-gray-700">Thủ thuật/can thiệp:</p>
                                        <p class="text-sm text-gray-600">Không có.</p>
                                    </div>
                                    <div class="kcb-detail-item">
                                        <p class="font-semibold text-gray-700">Tình trạng sau điều trị:</p>
                                        <p class="text-sm text-gray-600">Triệu chứng giảm rõ rệt sau 3 ngày, đã hết sốt.</p>
                                    </div>
                                    <div class="kcb-detail-item">
                                        <p class="font-semibold text-gray-700">Hẹn tái khám:</p>
                                        <p class="text-sm text-gray-600 font-medium text-red-500">Không cần tái khám nếu tình trạng ổn định.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Khám lần 2 (Ngày khám: Accordion Item) -->
                        <div class="kcb-accordion-item rounded-lg border border-gray-200">
                            <div class="kcb-accordion-header color-dark-text" onclick="toggleAccordion(this)">
                                <span>Ngày khám: 02/09/2025</span>
                                <svg class="w-5 h-5 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="kcb-accordion-content">
                                <div class="space-y-3">
                                    <div class="kcb-detail-item">
                                        <p class="font-semibold text-gray-700">Triệu chứng:</p>
                                        <p class="text-sm text-gray-600">Đau dạ dày âm ỉ, ợ chua sau khi ăn.</p>
                                    </div>
                                    <div class="kcb-detail-item">
                                        <p class="font-semibold text-gray-700">Chẩn đoán của bác sĩ:</p>
                                        <p class="text-sm text-gray-600 color-primary-text font-medium">Trào ngược dạ dày thực quản (GERD).</p>
                                    </div>
                                    <div class="kcb-detail-item">
                                        <p class="font-semibold text-gray-700">Toa thuốc đã kê:</p>
                                        <p class="text-sm text-gray-600">Esomeprazole 40mg (1 viên/ngày, 14 ngày).</p>
                                    </div>
                                    <div class="kcb-detail-item">
                                        <p class="font-semibold text-gray-700">Hẹn tái khám:</p>
                                        <p class="text-sm text-gray-600 font-medium text-green-600">Tái khám sau 2 tuần để đánh giá lại.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Thêm các lần khám khác tại đây -->

                    </div>
                </div>

                <!-- Tab: Biến động chỉ số (MỤC MỚI) -->
                <div id="bien-dong-chi-so-content" class="tab-content hidden">
                    <h1 class="text-2xl md:text-3xl font-bold color-dark-text mb-6 pb-2 border-b-2 border-color-primary">
                        Biến động chỉ số sức khỏe (7 ngày gần nhất)
                    </h1>
                    
                    <!-- ĐÃ CHỈNH SỬA: grid-cols-1 trên mobile, md:grid-cols-2 trên tablet/desktop -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Biểu đồ Huyết áp -->
                        <div class="bg-gray-50 p-4 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-lg font-bold color-dark-text mb-4 text-center">Huyết áp (mmHg)</h3>
                            <div class="chart-container">
                                <canvas id="chart-blood-pressure"></canvas>
                            </div>
                        </div>
                        
                        <!-- Biểu đồ Nhịp tim -->
                        <div class="bg-gray-50 p-4 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-lg font-bold color-dark-text mb-4 text-center">Nhịp tim (bpm)</h3>
                            <div class="chart-container">
                                <canvas id="chart-heart-rate"></canvas>
                            </div>
                        </div>
                        
                        <!-- Biểu đồ SpO₂ -->
                        <div class="bg-gray-50 p-4 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-lg font-bold color-dark-text mb-4 text-center">SpO₂ (%)</h3>
                            <div class="chart-container">
                                <canvas id="chart-spo2"></canvas>
                            </div>
                        </div>
                        
                        <!-- Biểu đồ Nhịp thở -->
                        <div class="bg-gray-50 p-4 rounded-xl shadow-lg border border-gray-200">
                            <h3 class="text-lg font-bold color-dark-text mb-4 text-center">Nhịp thở (breaths/min)</h3>
                            <div class="chart-container">
                                <canvas id="chart-respiratory-rate"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Thông tin cá nhân -->
                <div id="thong-tin-ca-nhan-content" class="tab-content hidden">
                    <h1 class="text-2xl md:text-3xl font-bold color-dark-text mb-6 pb-2 border-b-2 border-color-primary">
                        Thông tin cá nhân
                    </h1>
                    <div class="space-y-4 text-gray-700">
                        <p><span class="font-semibold w-24 md:w-32 inline-block">Họ và Tên:</span> Nguyễn Văn A</p>
                        <p><span class="font-semibold w-24 md:w-32 inline-block">MSBN:</span> 12345678</p>
                        <p><span class="font-semibold w-24 md:w-32 inline-block">Ngày sinh:</span> 10/10/1990</p>
                        <p><span class="font-semibold w-24 md:w-32 inline-block">Giới tính:</span> Nam</p>
                        <p><span class="font-semibold w-24 md:w-32 inline-block">Địa chỉ:</span> 123 Đường ABC, Quận 1, TP. HCM</p>
                        <p><span class="font-semibold w-24 md:w-32 inline-block">Số điện thoại:</span> 090xxxxxxx</p>
                        
                        <!-- Mục BMI -->
                        <p class="pt-2"><span class="font-semibold w-24 md:w-32 inline-block">Cân nặng:</span> 70 kg</p>
                        <p><span class="font-semibold w-24 md:w-32 inline-block">Chiều cao:</span> 1.75 m</p>
                        <p><span class="font-semibold w-24 md:w-32 inline-block">BMI:</span> <span class="font-bold color-primary-text">22.86 (Bình thường)</span></p>
                        
                        <!-- Mục Dị ứng -->
                        <p class="pt-4"><span class="font-semibold w-24 md:w-32 inline-block">Nhóm máu:</span> O+</p>
                        <p><span class="font-semibold w-24 md:w-32 inline-block">Các loại dị ứng:</span> <span class="font-medium text-red-600">Penicillin, Tôm</span></p>

                        <button class="color-primary text-white px-4 py-2 mt-4 rounded-lg font-semibold hover:bg-opacity-90 transition">
                            Chỉnh sửa thông tin
                        </button>
                    </div>
                </div>

                <!-- Tab: HD chăm sóc sức khỏe -->
                <div id="hd-cham-soc-content" class="tab-content hidden">
                    <h1 class="text-2xl md:text-3xl font-bold color-dark-text mb-6 pb-2 border-b-2 border-color-primary">
                        Hướng dẫn chăm sóc sức khỏe
                    </h1>
                    
                    <!-- Loading Indicator (Hiển thị khi đang "tạo" hướng dẫn) -->
                    <div id="hd-cham-soc-loading" class="flex items-center justify-center py-10 hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-gray-500">Đang tạo hướng dẫn cá nhân...</span>
                    </div>

                    <!-- Dynamic Content Area (Nội dung được tạo ra) -->
                    <div id="hd-cham-soc-content-dynamic" class="space-y-4 text-gray-700">
                        <!-- Content will be loaded here by JavaScript -->
                    </div>
                </div>

                <!-- MỤC MỚI: Tab Hỗ trợ chẩn đoán -->
                <div id="ho-tro-chan-doan-content" class="tab-content hidden">
                    <h1 class="text-2xl md:text-3xl font-bold color-dark-text mb-6 pb-2 border-b-2 border-color-primary">
                        Hỗ trợ chẩn đoán
                    </h1>
                    
                    <!-- Loading Indicator -->
                    <div id="ho-tro-chan-doan-loading" class="flex items-center justify-center py-10 hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-gray-500">Đang phân tích dữ liệu và đưa ra khuyến nghị...</span>
                    </div>

                    <!-- Dynamic Content Area -->
                    <div id="ho-tro-chan-doan-content-dynamic" class="space-y-4 text-gray-700">
                        <p class="text-sm text-gray-500 italic">Chọn tab "Hỗ trợ chẩn đoán" để bắt đầu phân tích từ lần khám gần nhất.</p>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // --- LOGIC GIẢ LẬP TẠO NỘI DUNG AI VÀ DỮ LIỆU CHỈ SỐ SỨC KHỎE ---
        
        // Dữ liệu mô phỏng lấy từ hồ sơ cá nhân và lần khám gần nhất
        const MOCK_PERSONAL_INFO = {
            weight: 70, 
            height: 1.75, 
            allergies: ["Penicillin", "Tôm"]
        };
        // Cập nhật dữ liệu khám gần nhất để bao gồm các thông tin chẩn đoán
        const MOCK_LAST_DIAGNOSIS = {
            date: "15/11/2025", 
            diagnosis: "Viêm họng cấp do virus",
            symptoms: "Sốt cao 39 độ, đau họng, ho khan liên tục.",
            results: "Xét nghiệm máu (CBC): Bạch cầu tăng nhẹ. Phim X-quang phổi: Trong giới hạn bình thường."
        };

        // Dữ liệu mô phỏng Biến động chỉ số (14 chu kỳ ~ 7 ngày)
        // Dữ liệu được đảo ngược (.reverse()) để phần tử cuối cùng là chu kỳ gần nhất
        const MOCK_VITAL_SIGNS = {
            labels: Array.from({ length: 14 }, (_, i) => `Chu kỳ ${14 - i}`),
            bloodPressure: {
                // SBP (Tâm thu)
                systolic: [120, 122, 125, 130, 135, 132, 128, 120, 118, 120, 122, 124, 121, 120].reverse(),
                // DBP (Tâm trương)
                diastolic: [80, 81, 85, 88, 92, 90, 85, 78, 75, 78, 80, 82, 79, 77].reverse() 
            },
            heartRate: [72, 75, 78, 85, 90, 88, 80, 75, 73, 76, 74, 75, 76, 78].reverse(), // Nhịp tim (bpm)
            spo2: [98, 97, 96, 95, 96, 97, 98, 98, 99, 98, 97, 98, 99, 99].reverse(), // SpO2 (%)
            respiratoryRate: [14, 15, 16, 18, 20, 19, 17, 15, 14, 15, 16, 17, 15, 14].reverse() // Nhịp thở (breaths/min)
        };

        // Lấy các chỉ số gần nhất để phân tích
        const MOCK_LATEST_VITALS = {
            bp: `${MOCK_VITAL_SIGNS.bloodPressure.systolic.slice(-1)[0]}/${MOCK_VITAL_SIGNS.bloodPressure.diastolic.slice(-1)[0]} mmHg`,
            hr: `${MOCK_VITAL_SIGNS.heartRate.slice(-1)[0]} bpm`,
            spo2: `${MOCK_VITAL_SIGNS.spo2.slice(-1)[0]} %`,
            rr: `${MOCK_VITAL_SIGNS.respiratoryRate.slice(-1)[0]} breaths/min`,
            // Lấy dữ liệu 5 chu kỳ gần nhất để phân tích xu hướng
            bpTrend: MOCK_VITAL_SIGNS.bloodPressure.systolic.slice(-5),
            hrTrend: MOCK_VITAL_SIGNS.heartRate.slice(-5)
        };


        /**
         * Giả lập lời gọi đến Gemini API để tạo hướng dẫn chăm sóc sức khỏe cá nhân hóa.
         * ĐÃ CẬP NHẬT: Thêm phần phân tích chỉ số sức khỏe gần nhất.
         */
        function generateHealthGuidance(personalInfo, lastDiagnosis) {
            
            const allergies = personalInfo.allergies.join(', ');
            const diagnosis = lastDiagnosis.diagnosis;
            const bmi = (personalInfo.weight / (personalInfo.height * personalInfo.height)).toFixed(2);
            let bmiAdvice = "Chỉ số BMI của bạn đang ở mức **Bình thường**. Hãy duy trì thói quen ăn uống cân bằng và tập thể dục vừa phải (30 phút/ngày, 5 ngày/tuần) để giữ vững cân nặng lý tưởng.";
            if (bmi < 18.5) {
                bmiAdvice = "Chỉ số BMI cho thấy bạn đang **thiếu cân**. Cần tham khảo ý kiến bác sĩ hoặc chuyên gia dinh dưỡng để tăng cân an toàn.";
            } else if (bmi > 25) {
                bmiAdvice = "Chỉ số BMI cho thấy bạn đang **thừa cân**. Cần điều chỉnh chế độ ăn và tăng cường vận động để giảm nguy cơ bệnh tim mạch.";
            }

            // Phân tích chỉ số mới
            const latestVitals = MOCK_LATEST_VITALS;
            const bpStatus = MOCK_VITAL_SIGNS.bloodPressure.systolic.slice(-1)[0] >= 130 ? "Hơi cao" : "Ổn định";


            const guidanceContent = `
                <p class="text-sm text-gray-700 mb-4 font-medium italic">Hướng dẫn này được tổng hợp tự động dựa trên hồ sơ cá nhân, lần khám gần nhất (${lastDiagnosis.date}) và chỉ số sức khỏe mới nhất.</p>

                <div class="border-l-4 border-color-primary pl-4 py-2">
                    <p class="font-semibold color-dark-text text-lg">1. Chăm sóc sau khám (Chẩn đoán: ${diagnosis}):</p>
                    <ul class="list-disc list-inside ml-4 space-y-1 text-sm text-gray-600">
                        <li>Tiếp tục nghỉ ngơi và uống đủ nước ấm để làm dịu cổ họng.</li>
                        <li>Tránh ăn đồ quá nóng hoặc quá lạnh để không kích thích thêm vùng họng.</li>
                        <li>Giữ ấm cơ thể và hạn chế tiếp xúc với khói bụi.</li>
                    </ul>
                </div>
                
                <div class="border-l-4 border-red-500 pl-4 py-2 mt-4">
                    <p class="font-semibold text-red-600 text-lg">2. Cảnh báo Dị ứng quan trọng:</p>
                    <p class="text-sm text-gray-700 font-bold mb-2">Bạn bị dị ứng với: <span class="text-red-600">${allergies}</span></p>
                    <ul class="list-disc list-inside ml-4 space-y-1 text-sm text-gray-600">
                        <li>Tuyệt đối **tránh sử dụng Penicillin** và tất cả các loại thuốc có liên quan. Luôn thông báo rõ ràng về dị ứng thuốc này khi nhận đơn thuốc mới.</li>
                        <li>**Tránh ăn Tôm** để phòng ngừa phản ứng dị ứng thực phẩm nghiêm trọng.</li>
                    </ul>
                </div>

                <div class="border-l-4 border-green-500 pl-4 py-2 mt-4">
                    <p class="font-semibold color-dark-text text-lg">3. Lời khuyên về Thể chất (BMI ${bmi}):</p>
                    <p class="text-sm text-gray-600">${bmiAdvice}</p>
                </div>

                <!-- MỤC MỚI: PHÂN TÍCH CHỈ SỐ SỨC KHỎE -->
                <div class="border-l-4 border-yellow-500 pl-4 py-2 mt-4">
                    <p class="font-semibold text-yellow-700 text-lg">4. Đánh giá Chỉ số Sức khỏe Gần nhất:</p>
                    <p class="text-sm text-gray-700">Đọc gần nhất (Chu kỳ 14): HA ${latestVitals.bp}, Nhịp tim ${latestVitals.hr}, SpO₂ ${latestVitals.spo2}.</p>
                    <p class="text-xs text-gray-600 mt-1">Huyết áp: <span class="font-bold text-red-500">${bpStatus}</span>. (Kiểm tra lại nếu HA vượt 140/90). Nhịp tim và SpO₂ nằm trong giới hạn bình thường.</p>
                </div>
            `;

            return new Promise(resolve => {
                setTimeout(() => {
                    resolve({ title: "Hướng dẫn chăm sóc sức khỏe", content: guidanceContent });
                }, 800); // Giả lập độ trễ mạng
            });
        }

        async function loadHealthGuidance() {
            const contentDiv = document.getElementById('hd-cham-soc-content-dynamic');
            const loadingDiv = document.getElementById('hd-cham-soc-loading');
            
            if (loadingDiv) loadingDiv.classList.remove('hidden');
            if (contentDiv) contentDiv.innerHTML = '';
            
            try {
                // Tải nội dung bằng hàm giả lập AI
                const result = await generateHealthGuidance(MOCK_PERSONAL_INFO, MOCK_LAST_DIAGNOSIS);
                if (contentDiv) {
                    contentDiv.innerHTML = result.content;
                }
            } catch (error) {
                if (contentDiv) {
                    contentDiv.innerHTML = '<p class="text-red-500">Lỗi khi tải hướng dẫn. Vui lòng thử lại.</p>';
                }
                console.error("Error generating guidance:", error);
            } finally {
                if (loadingDiv) loadingDiv.classList.add('hidden');
            }
        }
        
        /**
         * Giả lập lời gọi đến Gemini API để hỗ trợ chẩn đoán.
         * ĐÃ CẬP NHẬT: Thêm phần phân tích Biến động chỉ số.
         */
        function generateDiagnosticSupport(lastDiagnosis) {
            
            const { date, symptoms, results } = lastDiagnosis;
            const latestVitals = MOCK_LATEST_VITALS;

            // Phân tích xu hướng nhịp tim (ví dụ: nếu có lúc nào đó vượt 90bpm)
            const hrTrendMsg = latestVitals.hrTrend.some(hr => hr > 90) ? "Đã ghi nhận đỉnh nhịp tim (ví dụ: >90 bpm) trong các chu kỳ trước, có thể liên quan đến tình trạng sốt cao hoặc căng thẳng." : "Nhịp tim duy trì ổn định, không có dấu hiệu nhịp nhanh kéo dài.";

            // Đề xuất chẩn đoán
            const aiRecommendation = "Viêm họng cấp tính do căn nguyên virus (Acute Viral Pharyngitis)";
            const suggestedTreatment = "Điều trị hỗ trợ và triệu chứng. Antipyretics (Paracetamol) liều phù hợp, bù dịch đường uống tích cực. Kháng sinh (Antibiotics) không được chỉ định do không có bằng chứng nhiễm khuẩn tiên phát.";

            // Phân tích chuyên sâu
            const reasoning = `
                <p class="mb-3 font-semibold text-gray-800">Phân tích dữ liệu cận lâm sàng, triệu chứng và Biến động chỉ số (Ngày ${date} và Chu kỳ 14):</p>
                <div class="space-y-3">
                    <div class="border-l-2 border-yellow-500 pl-3">
                        <p class="font-semibold text-gray-700">1. Triệu chứng lâm sàng:</p>
                        <p class="text-sm text-gray-600 italic">${symptoms}</p>
                        <p class="text-xs text-gray-500 mt-1">Sốt cao (39°C) kết hợp đau họng và ho khan là hội chứng hô hấp trên không đặc hiệu, thường gặp trong các bệnh lý cấp tính do virus.</p>
                    </div>

                    <div class="border-l-2 border-yellow-500 pl-3">
                        <p class="font-semibold text-gray-700">2. Kết quả Xét nghiệm (CBC):</p>
                        <p class="text-sm text-gray-600 italic">Bạch cầu tăng nhẹ (Mild Leukocytosis).</p>
                        <p class="text-xs text-gray-500 mt-1">Sự gia tăng nhẹ số lượng bạch cầu có thể xuất hiện trong giai đoạn sớm của nhiễm virus hoặc nhiễm khuẩn nhẹ không điển hình. Việc không ghi nhận tăng bạch cầu hạt **giảm xác suất** căn nguyên do vi khuẩn.</p>
                    </div>

                    <div class="border-l-2 border-yellow-500 pl-3">
                        <p class="font-semibold text-gray-700">3. Phân tích Biến động Chỉ số Gần nhất:</p>
                        <p class="text-sm text-gray-600 italic">HA: ${latestVitals.bp}, HR: ${latestVitals.hr}, SpO₂: ${latestVitals.spo2}, RR: ${latestVitals.rr}.</p>
                        <p class="text-xs text-gray-500 mt-1">${hrTrendMsg} Chỉ số SpO₂ và Huyết áp duy trì ổn định, loại trừ tình trạng suy hô hấp hoặc biến động tuần hoàn cấp tính.</p>
                    </div>

                    <div class="border-l-4 border-red-500 pl-3 pt-2">
                        <p class="font-semibold text-red-700">KẾT LUẬN CHUYÊN SÂU:</p>
                        <p class="text-sm text-gray-800 mt-1">Sự kết hợp giữa triệu chứng lâm sàng và các chỉ số không ủng hộ nhiễm khuẩn nặng hoặc biến chứng nặng (theo X-quang và Chỉ số sinh tồn) dẫn đến ưu tiên chẩn đoán Viêm họng cấp do virus. Khuyến nghị duy trì phác đồ điều trị bảo tồn.</p>
                    </div>
                </div>
                <p class="mt-4 font-semibold text-sm text-red-500 italic">Lưu ý: Khuyến nghị này là công cụ hỗ trợ lâm sàng, quyết định chẩn đoán và điều trị cuối cùng cần được xác nhận bởi bác sĩ chuyên khoa.</p>
            `;

            const diagnosticContent = `
                <p class="text-sm text-gray-700 mb-6 font-medium italic">Phân tích chuyên sâu dữ liệu khám gần nhất: ${date}</p>

                <div class="p-4 rounded-lg bg-red-50 border border-red-200">
                    <p class="font-bold text-red-700 text-lg mb-2">Đề xuất chẩn đoán:</p>
                    <p class="text-xl font-bold color-dark-text">${aiRecommendation}</p>
                </div>

                <div class="mt-4 p-4 rounded-lg bg-blue-50 border border-blue-200">
                    <p class="font-bold color-primary-text text-lg mb-2">Phác đồ điều trị đề xuất:</p>
                    <p class="text-base text-gray-700">${suggestedTreatment}</p>
                </div>

                <div class="mt-6">
                    <p class="font-bold color-dark-text text-lg mb-2 border-b pb-1">Cơ sở lý luận lâm sàng:</p>
                    <div class="text-sm">${reasoning}</div>
                </div>
            `;

            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(diagnosticContent);
                }, 1000); // Giả lập độ trễ mạng lâu hơn (1s)
            });
        }

        async function loadDiagnosticSupport() {
            const contentDiv = document.getElementById('ho-tro-chan-doan-content-dynamic');
            const loadingDiv = document.getElementById('ho-tro-chan-doan-loading');
            
            if (loadingDiv) loadingDiv.classList.remove('hidden');
            if (contentDiv) contentDiv.innerHTML = '';
            
            try {
                const content = await generateDiagnosticSupport(MOCK_LAST_DIAGNOSIS);
                if (contentDiv) {
                    contentDiv.innerHTML = content;
                }
            } catch (error) {
                if (contentDiv) {
                    contentDiv.innerHTML = '<p class="text-red-500">Lỗi khi tải hỗ trợ chẩn đoán. Vui lòng thử lại.</p>';
                }
                console.error("Error generating diagnostic support:", error);
            } finally {
                if (loadingDiv) loadingDiv.classList.add('hidden');
            }
        }


        // --- LOGIC VẼ BIỂU ĐỒ CHART.JS ---
        let charts = {}; // Dùng để lưu trữ các đối tượng biểu đồ để hủy bỏ khi chuyển tab

        function createChart(ctxId, label, data, borderColor, backgroundColor, type = 'line', secondaryData = null) {
            // Hủy bỏ biểu đồ cũ nếu có để tránh lỗi khi render lại
            if (charts[ctxId]) {
                charts[ctxId].destroy(); 
            }
            
            let datasets = [{
                label: label,
                data: data,
                borderColor: borderColor,
                backgroundColor: backgroundColor,
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6,
            }];
            
            if (secondaryData) {
                // Thiết lập datasets cho biểu đồ Huyết áp (gồm 2 đường)
                datasets = [
                    {
                        label: 'Tâm thu (SBP)',
                        data: data,
                        borderColor: '#DC2626', // Red
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                    },
                    {
                        label: 'Tâm trương (DBP)',
                        data: secondaryData,
                        borderColor: '#2563EB', // Blue
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                    }
                ];
            }
            
            const ctx = document.getElementById(ctxId).getContext('2d');
            charts[ctxId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: MOCK_VITAL_SIGNS.labels,
                    datasets: datasets,
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Cho phép chart-container kiểm soát kích thước
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: label.split(' ')[0]
                            }
                        },
                        x: {
                            reverse: true, // Hiển thị chu kỳ mới nhất ở bên phải
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: secondaryData !== null, // Chỉ hiển thị legend cho Huyết áp
                            position: 'top',
                        },
                        title: {
                            display: false,
                        }
                    }
                }
            });
        }

        function loadIndexFluctuation() {
            // Biểu đồ Huyết áp (Dùng 2 đường line)
            createChart('chart-blood-pressure', 'Huyết áp (mmHg)', MOCK_VITAL_SIGNS.bloodPressure.systolic, '#DC2626', 'rgba(220, 38, 38, 0.3)', 'line', MOCK_VITAL_SIGNS.bloodPressure.diastolic);
            
            // Biểu đồ Nhịp tim
            createChart('chart-heart-rate', 'Nhịp tim (bpm)', MOCK_VITAL_SIGNS.heartRate, '#FBBF24', 'rgba(251, 191, 36, 0.3)', 'line');
            
            // Biểu đồ SpO2
            createChart('chart-spo2', 'SpO₂ (%)', MOCK_VITAL_SIGNS.spo2, '#10B981', 'rgba(16, 185, 129, 0.3)', 'line');

            // Biểu đồ Nhịp thở
            createChart('chart-respiratory-rate', 'Nhịp thở (breaths/min)', MOCK_VITAL_SIGNS.respiratoryRate, '#6366F1', 'rgba(99, 102, 241, 0.3)', 'line');
        }


        // --- Logic Tab Navigation ---
        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.sidebar-nav-item');
            const contentAreas = document.querySelectorAll('.tab-content');

            // Hàm chuyển đổi tab
            function switchTab(targetTabId) {
                // Xóa trạng thái active khỏi tất cả nav items
                navItems.forEach(item => {
                    item.classList.remove('active');
                    item.classList.remove('bg-white');
                    item.classList.add('color-dark-text', 'bg-white'); 
                });
                
                // Ẩn tất cả content areas
                contentAreas.forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Hiển thị content area mục tiêu
                const targetContent = document.getElementById(targetTabId + '-content');
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                }

                // LOGIC ĐẶC BIỆT: Tải nội dung AI và Biểu đồ khi chọn tab lần đầu
                if (targetTabId === 'hd-cham-soc' && !targetContent.hasAttribute('data-loaded')) {
                    targetContent.setAttribute('data-loaded', 'true'); 
                    loadHealthGuidance(); 
                } else if (targetTabId === 'ho-tro-chan-doan' && !targetContent.hasAttribute('data-loaded')) {
                    targetContent.setAttribute('data-loaded', 'true');
                    loadDiagnosticSupport();
                } else if (targetTabId === 'bien-dong-chi-so') {
                    // Luôn tải lại biểu đồ để đảm bảo Chart.js render đúng trong DOM hiện tại
                    loadIndexFluctuation();
                }

                // Đặt trạng thái active cho nav item được chọn
                const activeNavItem = document.querySelector(`[data-tab="${targetTabId}"]`);
                if (activeNavItem) {
                    activeNavItem.classList.add('active');
                    activeNavItem.classList.remove('color-dark-text', 'bg-white'); 
                }
            }

            // Gán sự kiện click cho nav items
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const targetTabId = item.getAttribute('data-tab');
                    switchTab(targetTabId);
                });
            });

            // Khởi tạo: Đảm bảo tab 'Lịch sử KCB' được chọn ngay từ đầu
            switchTab('lich-su-kcb');
        });

        // --- Logic Accordion (cho Lịch sử KCB) ---
        function toggleAccordion(headerElement) {
            // Tìm phần tử cha (kcb-accordion-item)
            const item = headerElement.closest('.kcb-accordion-item');
            if (!item) return;

            // Tìm nội dung (kcb-accordion-content) và icon
            const content = item.querySelector('.kcb-accordion-content');
            const icon = headerElement.querySelector('svg');

            // Đóng/mở nội dung
            if (content.classList.contains('open')) {
                // Đóng
                content.classList.remove('open');
                icon.classList.remove('rotate-180');
                headerElement.classList.remove('color-primary-text', 'bg-color-light-bg');
                headerElement.classList.add('color-dark-text');
            } else {
                // Mở
                content.classList.add('open');
                icon.classList.add('rotate-180');
                headerElement.classList.add('color-primary-text', 'bg-color-light-bg');
                headerElement.classList.remove('color-dark-text');
            }
        }

        // Đóng lần khám thứ hai khi tải trang (do lần 1 đã mặc định mở)
        document.addEventListener('DOMContentLoaded', () => {
            const secondHeader = document.querySelectorAll('.kcb-accordion-header')[1];
            if (secondHeader) {
                const content = secondHeader.nextElementSibling;
                if (content.classList.contains('open')) {
                    content.classList.remove('open');
                    secondHeader.querySelector('svg').classList.remove('rotate-180');
                }
            }
        });
    </script>
</body>
</html>
